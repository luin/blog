<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Good Practices to Structure an Express App | Zihua Li</title>
      <link href="http://zihua.li/feed" type="application/rss+xml" rel="alternate" title="Zihua Li RSS Feed" />
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Source+Code+Pro' rel='stylesheet' type='text/css'>
    <link rel='stylesheet'  href='http://zihua.li/theme/css/normalize.css' type='text/css' media='all' />
    <link rel='stylesheet'  href='http://zihua.li/theme/css/style.css' type='text/css' media='all' />
    <link rel='stylesheet'  href='http://zihua.li/theme/css/highlight.css' type='text/css' media='all' />
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <link rel="author" href="https://plus.google.com/107380206942623407058/posts" />
    <!--[if lt IE 9]> <script src="http://zihua.li/theme/js/vendor/html5shiv.js"></script> <![endif]-->
</head>
<body>
  <section class="l-cover">
    <header id="banner" class="body">
      <div class="header-avatar"><a href="http://zihua.li/"><img src="http://zihua.li/theme/images/avatar.png" width="64" height="64" alt="" /></a></div>
      <h1 class="site-name"><a href="http://zihua.li/">Zihua Li</a></h1>
      <p class="description">
        美工、全栈码农（Web, iOS）<br>90 后，法号 Luin<br />
        [<a href="http://zihua.li/pages/about/">关于</a>, <a href="http://zihua.li/pages/novel/">小说</a>]
      </p>
      <ul class="social-links">
        <li><a href="https://twitter.com/luinlee">Twitter</a></li>
        <li><a href="https://github.com/luin">GitHub</a></li>
        <li><a href="http://dribbble.com/luin">Dribbble</a></li>
      </ul>
    </header>
  </section>
  <section class="l-content">
    <div class="inner">
<article>
  <header>
    <p class="article-meta" title="2014-05-21T00:00:00">21 May 2014</p>
    <h2 class="article-title">Good Practices to Structure an Express App</h3>
  </header>
  <div class="typo article-body">
    <p>Having heavily used the <a href="http://expressjs.com">Express</a> framework for 3 years, I’ve discovered a few patterns and conventions to structure an Express app. These patterns make my code significantly cleaner and easier to follow. Here they are.</p>
<h2>1. RESTful Routes</h2>
<p>While there are many ways we can set up routes, the most important thing to keep in mind is to put the URL definition and its routes (i.e. middlewares) in the same place.</p>
<p>When writing code like <code>app.get('/users', require('./routes').getUsers)</code>, you are actually making your application fragmented instead of modular because the coupling between a URL and it's route is in fact relatively high.</p>
<p>For example, when making some changes on the <a href="http://expressjs.com/4x/api.html#req.params">named parameter</a> of the URL, you have to alter the route accordingly. If the url and the route definition are in different places, it takes more time to find them and change them both during development.</p>
<p>To modularize my Express app, what I do instead is to separate the routes by resources. In RESTful programming, a resource is similar to an object instance in an object-oriented programming language. The coupling between resources is low and each resource is relatively self-contained, which means they can be separated naturally.</p>


<p>Since Express can mount apps as middlewares, I create an app for each resource, and put them in their own modules. I put these modules in a sub-folder (e.g. <code>/routes</code>). Here's the structure of a typical Express project following this convention:</p>
<div class="highlight"><pre><span class="n">project</span>
  <span class="o">|-</span> <span class="n">routes</span>
  <span class="o">|</span>   <span class="o">|-</span> <span class="n">index</span><span class="p">.</span><span class="n">js</span>
  <span class="o">|</span>   <span class="o">|-</span> <span class="n">users</span><span class="p">.</span><span class="n">js</span>
  <span class="o">|</span>   <span class="o">|-</span> <span class="n">projects</span><span class="p">.</span><span class="n">js</span>
  <span class="o">|</span>   <span class="o">|-</span> <span class="n">tasks</span><span class="p">.</span><span class="n">js</span>
  <span class="o">|-</span> <span class="n">app</span><span class="p">.</span><span class="n">js</span>
</pre></div>


<p><code>routes/index.js</code> is used to load all the routes:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">routes</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;node-require-directory&#39;</span><span class="p">)(</span><span class="nx">__dirname</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">routes</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="s1">&#39;index&#39;</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">routes</span><span class="cp">[</span><span class="nb">key</span><span class="cp">]</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span>
</pre></div>


<p>Then it's easy to load all the routes in the <code>app.js</code> by just requiring the <code>routes/index.js</code>:</p>
<div class="highlight"><pre><span class="n">require</span><span class="p">(</span><span class="err">&#39;</span><span class="p">.</span><span class="o">/</span><span class="n">routes</span><span class="err">&#39;</span><span class="p">)(</span><span class="n">app</span><span class="p">);</span>
</pre></div>


<p>Notice that the mount path of a route is the basename of its source file. So we can define the user resource in the file <code>routes/users.js</code> like this:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/:userId&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// do something</span>
<span class="p">});</span>
</pre></div>


<p>It would be mounted as <code>/users/:userId</code> instead of <code>/:userId</code> because <code>app.js</code> used <code>/users</code> as the path prefix. Awesome!</p>
<h2>2. Global variables</h2>
<blockquote>
<p>Global variables are evil.</p>
</blockquote>
<p>Global variables are variables that are accessible from every scope in your project, even in different modules.</p>
<p>Many people think that global variables are evil and refuse to use them in their projects. But I believe that rational use of them can make your project more efficient to develop. For instance, database connections (or models if you are using ORM or ODM) are very well suited to be defined as global variables because they are used pervasively in a typical Express project.</p>
<p>The simplest way to create a global variable is to declare a variable without the <code>var</code> keyword. However, I strongly oppose this way because of its potential ambiguity. It is not clear whether a variable was intended as a global variable or if the developer forgot the <code>var</code>.</p>
<p>Instead, I declare a global variable by adding it to the <code>GLOBAL</code> object:</p>
<div class="highlight"><pre><span class="o">&gt;</span> <span class="n">GLOBAL</span><span class="p">.</span><span class="n">str</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">this</span> <span class="n">is</span> <span class="n">a</span> <span class="n">global</span> <span class="n">variable</span><span class="err">&#39;</span><span class="p">;</span>
<span class="err">&#39;</span><span class="n">this</span> <span class="n">is</span> <span class="n">a</span> <span class="n">global</span> <span class="n">variable</span><span class="err">&#39;</span>
<span class="o">&gt;</span> <span class="n">str</span>
<span class="err">&#39;</span><span class="n">this</span> <span class="n">is</span> <span class="n">a</span> <span class="n">global</span> <span class="n">variable</span><span class="err">&#39;</span>
</pre></div>


<p>I am a huge fan of ORM/ODM, and <a href="http://mongoosejs.com">Mongoose</a> and <a href="http://sequelizejs.com">Sequelize</a> are often used in my Express projects. When I use them, I would be bound to expose the ORM/ODM models as global variables so that I can access them everywhere:</p>
<div class="highlight"><pre><span class="nx">User</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="nx">email</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">email</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...</span>
<span class="p">});</span>
</pre></div>


<p>In the code above, the global variable <code>User</code> is a Mongoose model.</p>
<h2>3. Dependency Injection</h2>
<p>Middleware is a low-level concept of the <a href="http://www.senchalabs.org/connect/">Connect</a>, and it's not applicable to every scenario we come across when coding on a higher level. For instance, if you want to pass variables between middlewares, you have to tack on properties to <code>req</code>, which seems odd and uncontrollable(that you couldn't point out easily which middleware add what properties to <code>req</code>).</p>
<p>To avoid this problem, I wrote a library to bring dependency injection to the Express. Visit it's <a href="https://github.com/luin/express-di">GitHub page</a> to learn about what is it and how to use it.</p>
<p>I always create a <code>factories</code> folder to store all the dependencies in my Express app like this:</p>
<div class="highlight"><pre><span class="n">project</span>
  <span class="o">|-</span> <span class="n">factories</span>
  <span class="o">|</span>   <span class="o">|-</span> <span class="n">user</span><span class="p">.</span><span class="n">js</span>
  <span class="o">|</span>   <span class="o">|-</span> <span class="n">index</span><span class="p">.</span><span class="n">js</span>
  <span class="o">|-</span> <span class="n">app</span><span class="p">.</span><span class="n">js</span>
</pre></div>


<p>Just like routes, <code>factories/index.js</code> is used to load all the factories:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">factories</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;node-require-directory&#39;</span><span class="p">)(</span><span class="nx">__dirname</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">factories</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="s1">&#39;index&#39;</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">factory</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">factories</span><span class="cp">[</span><span class="nb">key</span><span class="cp">]</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span>
</pre></div>


<p>And in the <code>app.js</code>, we can <code>require</code> all the factories like this:</p>
<div class="highlight"><pre><span class="n">require</span><span class="p">(</span><span class="err">&#39;</span><span class="p">.</span><span class="o">/</span><span class="n">factories</span><span class="err">&#39;</span><span class="p">)(</span><span class="n">app</span><span class="p">);</span>
</pre></div>


<h2>4. Configuration</h2>
<p><a href="https://github.com/lorenwest/node-config">Node-config</a> is an awesome configuration system for Node.js. It loads different configurations according to the runtime environments (specified by <code>NODE_ENV</code>), and It's easy to use the configuration in the code, just <code>var config = require('config')</code>.</p>
<p>In my Express app, there's a <code>config</code> folder to hold all the configuration files. However, considering a config can vary between deploys, the only file to check into version control  is a sample config file named <code>_sample.yaml</code>. When deploying the app, just copy <code>_sample.yaml</code> to <code>$NODE_ENV.yaml</code>, usually <code>production.yaml</code>.</p>
<p>What's more, when using an automatic deployment script, it's not easy to change the configuration file. Luckily, Node-config supports environment variables and command line arguments as well.</p>
<h2>Conclusion</h2>
<p>I created a small reference app to codify a standard Express app structure. You can see it <a href="https://github.com/luin/express-mongoose">here</a>.</p>
  </div>
  <div class="hr"></div>
  <section class="article-share clearfix">
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    <div class="about-blog">
      <h4>关于此博客</h4>
      <p>Luin 的个人博客，主要关注互联网技术。</p>
      <a href="https://twitter.com/luinlee" class="twitter-follow-button" data-show-count="false" data-lang="en">Follow @luinlee</a>
    </div>
    <div class="share">
      <h4>分享这篇文章</h4>
      <a class="icon-social icon-social-twitter-bird" href="http://twitter.com/share?text=Good Practices to Structure an Express App&url=http://zihua.li/2014/05/good-practices-to-structure-an-express-app/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
      </a>
      <a class="icon-social icon-social-weibo" href="http://service.weibo.com/share/share.php?title=Good Practices to Structure an Express App&url=http://zihua.li/2014/05/good-practices-to-structure-an-express-app/" onclick="window.open(this.href, 'weibo-share', 'width=550,height=435');return false;">
        <span class="hidden">微博</span>
      </a>
    </div>
  </section>
  <div class="hr"></div>
<div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = 'zihuali';

(function() {
 var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
 dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
 (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
 })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</article>
    </div>
  </section>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-46124852-1', 'zihua.li');
    ga('send', 'pageview');
  </script>
</body>
</html>